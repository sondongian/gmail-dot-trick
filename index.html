<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gmail Dot Trick ‚Äì B·ªën L√π</title>

  <!-- Toastify CSS (ƒë·ªÉ hi·ªÉn th·ªã Toast Notification ƒë·∫πp) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

  <style>
    /* ===== Reset & Base ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      background-color: #f0f2f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      line-height: 1.5;
    }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }

    /* ===== Container & Header ===== */
    .container {
      max-width: 960px;
      margin: 30px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #d9230f;
      color: #fff;
      padding: 20px 30px;
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 600;
    }
    .dark-mode-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      font-size: 0.95rem;
    }
    .dark-mode-toggle input[type="checkbox"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      accent-color: #fff;
      cursor: pointer;
    }

    /* ===== Main Content ===== */
    .content {
      padding: 20px 30px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .form-group input[type="text"],
    .form-group input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.94rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color 0.2s;
    }
    .form-group input[type="text"]:focus,
    .form-group input[type="search"]:focus {
      border-color: #d9230f;
      outline: none;
    }
    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-right: 20px;
    }
    .checkbox-inline input[type="checkbox"] {
      margin-right: 6px;
      width: 16px;
      height: 16px;
      accent-color: #d9230f;
      cursor: pointer;
    }

    /* ===== Buttons ===== */
    .btn {
      display: inline-block;
      background-color: #d9230f;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      margin-right: 10px;
      margin-top: 4px;
    }
    .btn:hover {
      background-color: #b71c05;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .btn-secondary {
      background-color: #555;
    }
    .btn-secondary:hover {
      background-color: #444;
    }
    .btn-secondary:active {
      transform: translateY(1px);
    }
    .btn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    /* ===== Progress Bar ===== */
    #progressContainer {
      width: 100%;
      background: #eee;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }
    #progressBar {
      width: 0;
      height: 100%;
      background-color: #d9230f;
      transition: width 0.2s;
    }
    #progressText {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #555;
      display: none;
    }

    /* ===== Result Panel ===== */
    .result-panel {
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 380px;
      overflow-y: auto;
      background-color: #fafafa;
    }
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #e1e1e1;
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .result-list {
      width: 100%;
    }
    .email-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      transition: background 0.15s;
      font-size: 0.93rem;
    }
    .email-item:nth-child(even) {
      background: #fff;
    }
    .email-item:nth-child(odd) {
      background: #f9f9f9;
    }
    .email-item:hover {
      background: #f4f4f4;
    }
    .email-text {
      font-family: "Courier New", Courier, monospace;
      word-break: break-all;
      flex: 1;
      margin-left: 8px;
      margin-right: 8px;
    }
    .email-text.used {
      text-decoration: line-through;
      color: #999;
    }
    .item-controls {
      display: flex;
      align-items: center;
      margin-left: 12px;
    }
    .copy-btn {
      background: none;
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      margin-right: 10px;
      color: #555;
      transition: color 0.2s;
    }
    .copy-btn:hover {
      color: #d9230f;
    }
    .used-checkbox {
      width: 18px;
      height: 18px;
      accent-color: #d9230f;
      cursor: pointer;
    }
    .select-checkbox {
      width: 18px;
      height: 18px;
      accent-color: #d9230f;
      cursor: pointer;
      margin-right: 8px;
    }
    .email-item.highlight {
      background-color: #fff9c4;
      transition: background-color 0.5s ease;
    }

    /* ===== Notification (s·ªë l∆∞·ª£ng & toast) ===== */
    #countDisplay {
      font-weight: 600;
      color: #d9230f;
    }

    /* ===== Dark Mode Styles ===== */
    body.dark {
      background-color: #181a1b;
      color: #e0e0e0;
    }
    body.dark .container {
      background-color: #242526;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    body.dark input[type="text"],
    body.dark input[type="search"] {
      background-color: #2b2c2d;
      color: #e0e0e0;
      border-color: #444;
    }
    body.dark input[type="checkbox"] {
      accent-color: #d9230f;
    }
    body.dark .checkbox-inline {
      color: #ddd;
    }
    body.dark .btn-secondary {
      background-color: #444;
    }
    body.dark .btn-secondary:hover {
      background-color: #333;
    }
    body.dark .result-header {
      background: #3a3b3c;
      color: #e0e0e0;
      border-bottom-color: #444;
    }
    body.dark .result-panel {
      background-color: #1f1f1f;
      border-color: #444;
    }
    body.dark .email-item:nth-child(odd) {
      background-color: #2c2c2c;
    }
    body.dark .email-item:nth-child(even) {
      background-color: #1f1f1f;
    }
    body.dark .email-item:hover {
      background-color: #3a3b3c;
    }
    body.dark #progressContainer {
      background: #333;
    }
    body.dark #progressBar {
      background-color: #d9230f;
    }
    body.dark #progressText {
      color: #ccc;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>Gmail Dot Trick ‚Äì Modern</h1>
      <!-- Dark Mode Toggle -->
      <label class="dark-mode-toggle">
        <input type="checkbox" id="darkModeToggle" />
        Dark Mode
      </label>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content">
      <!-- Nh·∫≠p Username -->
      <div class="form-group">
        <label for="baseEmail">Ph·∫ßn Username (tr∆∞·ªõc @gmail.com):</label>
        <input type="text" id="baseEmail" placeholder="V√≠ d·ª•: abcdxyz12edsda2dadsad" />
      </div>

      <!-- Ch·ªçn domain -->
      <div class="form-group">
        <label class="checkbox-inline">
          <input type="checkbox" id="optGmail" value="gmail.com" checked /> @gmail.com
        </label>
        <label class="checkbox-inline">
          <input type="checkbox" id="optGooglemail" value="googlemail.com" /> @googlemail.com
        </label>
      </div>

      <!-- N√∫t h√†nh ƒë·ªông -->
      <div class="form-group">
        <button class="btn" id="btnGenerate">T·∫†O DANH S√ÅCH</button>
        <button class="btn btn-secondary" id="btnCopyAll" disabled>SAO CH√âP T·∫§T C·∫¢</button>
        <button class="btn btn-secondary" id="btnDownloadTxt" disabled>T·∫¢I FILE (.txt)</button>
        <button class="btn btn-secondary" id="btnClearChecked" disabled>XO√Å ƒê√ÅNH D·∫§U</button>
      </div>

      <!-- Thanh T√¨m ki·∫øm -->
      <div class="form-group">
        <label for="filterInput">T√¨m ki·∫øm (l·ªçc) trong k·∫øt qu·∫£:</label>
        <input type="search" id="filterInput" placeholder="Nh·∫≠p t·ª´ kho√° ƒë·ªÉ l·ªçc..." disabled />
      </div>

      <!-- Progress Bar & Text -->
      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
      <div id="progressText"></div>

      <!-- Panel ch·ª©a k·∫øt qu·∫£ -->
      <div class="result-panel" id="resultPanel">
        <div class="result-header">
          <span>T·ªïng: <span id="countDisplay">0</span> emails</span>
          <span>(Cu·ªôn ƒë·ªÉ xem)</span>
        </div>
        <div class="result-list" id="resultList">
          <!-- Email items s·∫Ω ƒë∆∞·ª£c ƒë·ªï v√†o ƒë√¢y -->
        </div>
      </div>
    </div>
  </div>
  <!-- ====== FOOTER ‚Äì Ch·ªØ k√Ω ====== -->
  <footer class="footer">
    <div class="footer-content">
      ¬© 2025 ‚Äî Trang ‚ÄúGmail Dot Trick‚Äù x√¢y d·ª±ng b·ªüi <strong>Nguy·ªÖn Thanh S∆°n</strong>
    </div>
  </footer>
</body>
</html>

  <!-- Toastify JS (ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o d·∫°ng toast) -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
    (function() {
      // ==== C√°c ph·∫ßn t·ª≠ DOM quan tr·ªçng ====
      const baseInput       = document.getElementById('baseEmail');
      const chkGmail        = document.getElementById('optGmail');
      const chkGooglemail   = document.getElementById('optGooglemail');
      const btnGenerate     = document.getElementById('btnGenerate');
      const btnCopyAll      = document.getElementById('btnCopyAll');
      const btnDownloadTxt  = document.getElementById('btnDownloadTxt');
      const btnClearChecked = document.getElementById('btnClearChecked');
      const filterInput     = document.getElementById('filterInput');
      const resultList      = document.getElementById('resultList');
      const countDisplay    = document.getElementById('countDisplay');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar       = document.getElementById('progressBar');
      const progressText      = document.getElementById('progressText');
      const darkModeToggle  = document.getElementById('darkModeToggle');

      // ==== State to√†n c·ª•c ====
      let currentBase       = "";
      let currentDomains    = [];        // m·∫£ng l∆∞u domain: ["gmail.com", "googlemail.com", ...]
      let currentEmails     = [];        // m·∫£ng l∆∞u to√†n b·ªô email ƒë√£ generate
      let usedSet           = new Set(); // Set l∆∞u email ƒë√£ ƒë√°nh d·∫•u ‚Äúƒê√£ d√πng‚Äù
      let selectedSet       = new Set(); // Set l∆∞u email ƒë√£ ‚ÄúSelect ƒë·ªÉ copy‚Äù
      let storageKeyUsed    = "";        // key localStorage cho ‚Äúƒê√£ d√πng‚Äù
      let worker            = null;      // bi·∫øn ch·ª©a Web Worker

      // ==== H√†m hi·ªÉn th·ªã Toast ====
      function showToast(message, type = "success") {
        Toastify({
          text: message,
          duration: 1800,
          gravity: "top",
          position: "right",
          backgroundColor: type === "error" ? "#e74c3c" : "#27ae60"
        }).showToast();
      }

      // ==== L∆∞u / Load tr·∫°ng th√°i Dark Mode ====
      function loadDarkMode() {
        const val = localStorage.getItem("darkModeEnabled");
        if (val === "true") {
          document.body.classList.add("dark");
          darkModeToggle.checked = true;
        } else {
          document.body.classList.remove("dark");
          darkModeToggle.checked = false;
        }
      }
      darkModeToggle.addEventListener("change", () => {
        if (darkModeToggle.checked) {
          document.body.classList.add("dark");
          localStorage.setItem("darkModeEnabled", "true");
        } else {
          document.body.classList.remove("dark");
          localStorage.setItem("darkModeEnabled", "false");
        }
      });

      // ==== L∆∞u / Load username l·∫ßn cu·ªëi (last base) ====
      function loadLastBase() {
        const last = localStorage.getItem("lastBaseUsername");
        if (last) {
          baseInput.value = last;
        }
      }
      baseInput.addEventListener("blur", () => {
        const val = baseInput.value.trim();
        if (val) localStorage.setItem("lastBaseUsername", val);
      });

      // ==== T√≠nh to√°n key localStorage cho ‚Äúƒê√£ d√πng‚Äù ====
      function getStorageKeyUsed(base, domainsArray) {
        // V√≠ d·ª•: usedEmails:abcd123@gmail.com_googlemail.com
        return `usedEmails:${base}@${domainsArray.join("_")}`;
      }

      // ==== Load Set email ‚Äúƒê√£ d√πng‚Äù t·ª´ localStorage ====
      function loadUsedSet() {
        usedSet.clear();
        if (!currentBase || !currentDomains.length) return;
        const key = storageKeyUsed;
        const json = localStorage.getItem(key);
        if (!json) return;
        try {
          const arr = JSON.parse(json);
          arr.forEach(e => usedSet.add(e));
        } catch {
          usedSet.clear();
        }
      }

      // ==== L∆∞u Set email ‚Äúƒê√£ d√πng‚Äù v√†o localStorage ====
      function saveUsedSet() {
        const key = storageKeyUsed;
        const arr = Array.from(usedSet);
        localStorage.setItem(key, JSON.stringify(arr));
      }

      // ==== X√≥a to√†n b·ªô ‚Äúƒê√£ d√πng‚Äù cho b·ªô key hi·ªán t·∫°i ====
      function clearUsedInStorage() {
        if (!storageKeyUsed) return;
        localStorage.removeItem(storageKeyUsed);
        usedSet.clear();
      }

      // ==== H√†m kh·ªüi t·∫°o Web Worker ƒë·ªÉ sinh dot-trick ====
      function startWorkerGenerate(base, domains) {
        // N·∫øu ƒë√£ c√≥ worker c≈©, terminate tr∆∞·ªõc
        if (worker) {
          worker.terminate();
          worker = null;
        }

        worker = new Worker("worker.js");
        worker.postMessage({ base, domains });

        // Hi·ªÉn th·ªã progress bar & text
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressText.style.display = "block";
        progressText.textContent = "ƒêang sinh: 0%";

        worker.onmessage = (e) => {
          const data = e.data;
          if (data.progress !== undefined && data.progress < 100) {
            // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
            const pct = data.progress;
            progressBar.style.width = pct + "%";
            progressText.textContent = `ƒêang sinh: ${pct}%`;
          }
          if (data.progress === 100 && data.emails) {
            // Khi worker g·ª≠i xong k·∫øt qu·∫£
            currentEmails = data.emails;
            // Load l·∫°i usedSet t·ª´ localStorage
            usedSet = new Set();
            loadUsedSet();
            // Hi·ªÉn th·ªã danh s√°ch
            renderEmailList();
            // C·∫≠p nh·∫≠t count
            countDisplay.textContent = currentEmails.length.toLocaleString("vi-VN");
            // B·∫≠t n√∫t t∆∞∆°ng ·ª©ng
            filterInput.disabled    = false;
            btnCopyAll.disabled     = false;
            btnDownloadTxt.disabled = false;
            btnClearChecked.disabled= false;

            showToast(`Ho√†n th√†nh: ƒë√£ t·∫°o ${currentEmails.length.toLocaleString("vi-VN")} email.`);

            // T·∫Øt progress bar sau 1.2s
            setTimeout(() => {
              progressContainer.style.display = "none";
              progressText.style.display = "none";
            }, 1200);

            // Terminate worker
            worker.terminate();
            worker = null;
          }
        };

        worker.onerror = (err) => {
          console.error("Worker error:", err);
          showToast("ƒê√£ x·∫£y ra l·ªói khi sinh danh s√°ch.", "error");
          worker.terminate();
          worker = null;
          progressContainer.style.display = "none";
          progressText.style.display = "none";
        };
      }

      // ==== H√†m render danh s√°ch email ====
      function renderEmailList() {
        resultList.innerHTML = "";
        const fragment = document.createDocumentFragment();
        const base = currentBase;
        const domains = currentDomains;

        currentEmails.forEach(email => {
          const item = document.createElement("div");
          item.className = "email-item";

          // Checkbox ‚ÄúSelect ƒë·ªÉ copy‚Äù
          const selChk = document.createElement("input");
          selChk.type = "checkbox";
          selChk.className = "select-checkbox";
          selChk.title = "Ch·ªçn email n√†y ƒë·ªÉ copy";
          selChk.addEventListener("change", () => {
            if (selChk.checked) {
              selectedSet.add(email);
            } else {
              selectedSet.delete(email);
            }
            btnCopySelected.disabled = (selectedSet.size === 0);
          });

          // Span hi·ªán email
          const spanText = document.createElement("span");
          spanText.className = "email-text";
          spanText.textContent = email;
          if (usedSet.has(email)) {
            spanText.classList.add("used");
          }

          // Controls (Copy ri√™ng + Checkbox ‚Äúƒê√£ d√πng‚Äù)
          const controls = document.createElement("div");
          controls.className = "item-controls";

          // N√∫t copy ƒë∆°n
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          copyBtn.title = "Copy email n√†y";
          copyBtn.textContent = "üìã";
          copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(email).then(() => {
              showToast(`ƒê√£ copy: ${email}`);
            }).catch(() => {
              alert("Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông. Vui l√≤ng copy th·ªß c√¥ng.");
            });
          });

          // Checkbox ‚Äúƒê√£ d√πng‚Äù
          const usedChk = document.createElement("input");
          usedChk.type = "checkbox";
          usedChk.className = "used-checkbox";
          usedChk.checked = usedSet.has(email);
          usedChk.title = "ƒê√°nh d·∫•u l√† 'ƒê√£ d√πng'";
          usedChk.addEventListener("change", () => {
            if (usedChk.checked) {
              usedSet.add(email);
              spanText.classList.add("used");
            } else {
              usedSet.delete(email);
              spanText.classList.remove("used");
            }
            saveUsedSet();
          });

          controls.appendChild(copyBtn);
          controls.appendChild(usedChk);

          item.appendChild(selChk);
          item.appendChild(spanText);
          item.appendChild(controls);

          fragment.appendChild(item);
        });

        resultList.appendChild(fragment);
      }

      // ==== H√†m l·ªçc (filter) danh s√°ch theo t·ª´ kho√° ====
      filterInput.addEventListener("input", () => {
        const keyword = filterInput.value.trim().toLowerCase();
        const items = resultList.querySelectorAll(".email-item");
        items.forEach(item => {
          const txt = item.querySelector(".email-text").textContent.toLowerCase();
          if (txt.includes(keyword)) {
            item.style.display = "";
          } else {
            item.style.display = "none";
          }
        });
        // N·∫øu user search > 3 k√Ω t·ª±, highlight d√≤ng ƒë·∫ßu ti√™n kh·ªõp
        if (keyword.length > 3) {
          const match = Array.from(items).find(item => {
            const t = item.querySelector(".email-text").textContent.toLowerCase();
            return t.includes(keyword);
          });
          if (match) {
            const topPos = match.offsetTop;
            document.getElementById("resultPanel").scrollTop = topPos - 20;
            match.classList.add("highlight");
            setTimeout(() => {
              match.classList.remove("highlight");
            }, 2000);
          }
        }
      });

      // ==== N√∫t ‚ÄúT·∫†O DANH S√ÅCH‚Äù ====
      btnGenerate.addEventListener("click", () => {
        const base = baseInput.value.trim();
        // Lo·∫°i b·ªè to√†n b·ªô d·∫•u ‚Äú.‚Äù g·ªëc n·∫øu c√≥
        const sanitized = base.replace(/\./g, "");
        if (!sanitized) {
          alert("Vui l√≤ng nh·∫≠p ph·∫ßn username (tr∆∞·ªõc @gmail.com).");
          return;
        }
        if (/[^a-zA-Z0-9]/.test(sanitized)) {
          alert("Username ch·ªâ ch·ª©a ch·ªØ (a-z, A-Z) v√† s·ªë (0-9), kh√¥ng ch·ª©a k√Ω t·ª± kh√°c.");
          return;
        }

        // X√°c ƒë·ªãnh domain ƒë∆∞·ª£c ch·ªçn
        const domains = [];
        if (chkGmail.checked) domains.push("gmail.com");
        if (chkGooglemail.checked) domains.push("googlemail.com");
        if (!domains.length) {
          alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt domain (@gmail.com ho·∫∑c @googlemail.com).");
          return;
        }

        // L∆∞u l·∫°i state
        currentBase = sanitized;
        currentDomains = domains.slice(); // copy
        storageKeyUsed = getStorageKeyUsed(sanitized, domains);

        // L∆∞u lastBaseUsername
        localStorage.setItem("lastBaseUsername", sanitized);

        // C·∫£nh b√°o n·∫øu username qu√° d√†i ‚Üí s·ªë t·ªï h·ª£p r·∫•t l·ªõn
        if (sanitized.length > 20) {
          const c = confirm("‚ö†Ô∏è Username kh√° d√†i, s·ªë email sinh ra c√≥ th·ªÉ r·∫•t l·ªõn v√† l√†m ƒë∆° tr√¨nh duy·ªát. Ti·∫øp t·ª•c?");
          if (!c) return;
        }

        // T·∫Øt c√°c n√∫t tr∆∞·ªõc khi ch·∫°y
        filterInput.disabled = true;
        btnCopyAll.disabled = true;
        btnDownloadTxt.disabled = true;
        btnClearChecked.disabled = true;
        resultList.innerHTML = "";
        countDisplay.textContent = "0";
        selectedSet.clear();

        // B·∫Øt ƒë·∫ßu b·∫±ng Web Worker
        startWorkerGenerate(sanitized, domains);
      });

      // ==== N√∫t ‚ÄúSAO CH√âP T·∫§T C·∫¢‚Äù ====
      btnCopyAll.addEventListener("click", () => {
        // L·∫•y t·∫•t c·∫£ item ƒëang hi·ªÉn th·ªã (ch∆∞a l·ªçc)
        const visibleItems = Array.from(resultList.querySelectorAll(".email-item"))
          .filter(item => item.style.display !== "none");
        if (!visibleItems.length) {
          alert("Kh√¥ng c√≥ email n√†o ƒë·ªÉ copy.");
          return;
        }
        const toCopy = visibleItems.map(item => item.querySelector(".email-text").textContent)
                                   .join("\n");
        navigator.clipboard.writeText(toCopy).then(() => {
          showToast(`ƒê√£ copy ${visibleItems.length.toLocaleString("vi-VN")} email.`);
        }).catch(() => {
          alert("Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông. Vui l√≤ng copy th·ªß c√¥ng.");
        });
      });

      // ==== N√∫t ‚ÄúT·∫¢I FILE (.txt)‚Äù ====
      btnDownloadTxt.addEventListener("click", () => {
        const visibleItems = Array.from(resultList.querySelectorAll(".email-item"))
          .filter(item => item.style.display !== "none");
        if (!visibleItems.length) {
          alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i file.");
          return;
        }
        const data = visibleItems.map(item => item.querySelector(".email-text").textContent)
                                  .join("\n");
        const ts = new Date().toISOString().replace(/[:.]/g, "-");
        const domainsKey = currentDomains.join("_");
        const fname = `${currentBase}_${domainsKey}_${ts}.txt`;
        downloadAsFile(fname, data);
      });

      // ==== N√∫t ‚ÄúXO√Å ƒê√ÅNH D·∫§U‚Äù ====
      btnClearChecked.addEventListener("click", () => {
        if (!currentBase) return;
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° m·ªçi d·∫•u ‚Äúƒê√£ d√πng‚Äù v√† d·ªçn localStorage?")) return;
        // X√≥a trong storage
        clearUsedInStorage();
        // B·ªè check, b·ªè class ‚Äúused‚Äù
        resultList.querySelectorAll(".email-item").forEach(item => {
          const span = item.querySelector(".email-text");
          const chk = item.querySelector(".used-checkbox");
          chk.checked = false;
          span.classList.remove("used");
        });
        showToast("ƒê√£ xo√° t·∫•t c·∫£ d·∫•u ‚Äúƒê√£ d√πng‚Äù.");
      });

      // ==== N√∫t ‚ÄúSAO CH√âP ƒê√É CH·ªåN‚Äù (Multi-select) ====
      // Ch√∫ng ta s·∫Ω t·∫°o n√∫t n√†y ƒë·ªông, ch·ªâ enable khi c√≥ √≠t nh·∫•t 1 email ƒë∆∞·ª£c ch·ªçn
      const btnCopySelected = document.createElement("button");
      btnCopySelected.className = "btn btn-secondary";
      btnCopySelected.id = "btnCopySelected";
      btnCopySelected.innerText = "SAO CH√âP ƒê√É CH·ªåN";
      btnCopySelected.disabled = true;
      // Th√™m v√†o sau btnClearChecked
      btnClearChecked.insertAdjacentElement("afterend", btnCopySelected);
      btnCopySelected.addEventListener("click", () => {
        if (!selectedSet.size) return;
        const arr = Array.from(selectedSet);
        const text = arr.join("\n");
        navigator.clipboard.writeText(text).then(() => {
          showToast(`ƒê√£ copy ${arr.length.toLocaleString("vi-VN")} email ƒë√£ ch·ªçn.`);
        }).catch(() => {
          alert("Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông. Vui l√≤ng copy th·ªß c√¥ng.");
        });
      });

      // Khi b·∫•t k·ª≥ checkbox ‚Äúselect‚Äù n√†o thay ƒë·ªïi (ƒë√£ g√°n event listener trong render),
      // btnCopySelected s·∫Ω ƒë∆∞·ª£c enable/disable t∆∞∆°ng ·ª©ng (xem trong renderEmailList).

      // ==== H√†m download file txt/csv ====
      function downloadAsFile(filename, content) {
        const blob = new Blob([content], { type: "text/plain" });
        const url  = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ==== C√°c ph√≠m t·∫Øt (Shortcuts) ====
      document.addEventListener("keydown", (e) => {
        // Ctrl + Shift + G ‚Üí focus v√†o input username
        if (e.ctrlKey && e.shiftKey && e.code === "KeyG") {
          e.preventDefault();
          baseInput.focus();
        }
        // Ctrl + Shift + C ‚Üí copy all
        if (e.ctrlKey && e.shiftKey && e.code === "KeyC") {
          e.preventDefault();
          if (!btnCopyAll.disabled) btnCopyAll.click();
        }
        // Ctrl + F ‚Üí focus v√†o filter
        if (e.ctrlKey && e.key === "f") {
          e.preventDefault();
          if (!filterInput.disabled) filterInput.focus();
        }
        // Ctrl + D ‚Üí clear ƒë√°nh d·∫•u ‚Äúƒê√£ d√πng‚Äù
        if (e.ctrlKey && e.code === "KeyD") {
          e.preventDefault();
          if (!btnClearChecked.disabled) btnClearChecked.click();
        }
      });

      // ==== Khi trang load l·∫ßn ƒë·∫ßu ====
      window.addEventListener("DOMContentLoaded", () => {
        loadDarkMode();
        loadLastBase();
      });
    })();
  </script>
</body>
</html>
